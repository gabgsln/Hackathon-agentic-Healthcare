{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CaseAnalysis",
  "description": "Validated output of the deterministic analysis pipeline.",
  "type": "object",
  "required": ["case_id", "overall_status", "evidence", "kpi", "dicom"],
  "additionalProperties": true,
  "properties": {
    "pipeline_version": {
      "type": "string",
      "description": "Semver string of the pipeline that produced this analysis."
    },
    "validation": {
      "type": "object",
      "description": "Clinical consistency validation block added by clinical_validation.py.",
      "required": ["confidence_score", "clinical_consistency_score", "anomaly_flags", "validated_at"],
      "additionalProperties": false,
      "properties": {
        "confidence_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Overall pipeline confidence (1.0 = fully consistent)."
        },
        "clinical_consistency_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Medical consistency of modality, HU range, spacing, and status."
        },
        "anomaly_flags": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Snake-case codes for each detected anomaly or quality issue."
        },
        "validation_notes": {
          "type": ["string", "null"],
          "description": "One-sentence summary of the most critical finding."
        },
        "validated_at": {
          "type": "string",
          "description": "ISO-8601 UTC timestamp of when validation was run."
        },
        "model_used": {
          "type": "string",
          "description": "LLM model ID used for validation."
        }
      }
    },
    "status_reason": {
      "type": "string",
      "enum": ["no_timeline", "insufficient_exams", "single_slice_limit", "computed"],
      "description": "Why overall_status has its current value."
    },
    "status_explanation": {
      "type": "string",
      "description": "Human-readable French explanation of the status reason."
    },
    "imaging": {
      "type": "object",
      "required": ["input_kind", "n_slices", "is_3d"],
      "additionalProperties": true,
      "description": "Describes the DICOM input geometry (single file vs. series folder).",
      "properties": {
        "input_kind": {
          "type": "string",
          "enum": ["single", "series"]
        },
        "n_slices": {
          "type": "integer",
          "minimum": 1
        },
        "volume_shape": {
          "type": "array",
          "items": {"type": ["integer", "null"]},
          "minItems": 3,
          "maxItems": 3
        },
        "spacing_mm": {
          "type": "array",
          "items": {"type": ["number", "null"]},
          "minItems": 3,
          "maxItems": 3
        },
        "series_instance_uid": {"type": ["string", "null"]},
        "sorting_key_used": {
          "type": "string",
          "enum": ["InstanceNumber", "ImagePositionPatient", "none"]
        },
        "is_3d": {"type": "boolean"}
      }
    },
    "case_id": {
      "type": "string",
      "minLength": 1,
      "description": "Unique case identifier."
    },
    "patient_id": {
      "type": "string"
    },
    "overall_status": {
      "type": "string",
      "enum": ["progression", "response", "stable", "unknown"],
      "description": "RECIST-like overall classification."
    },
    "evidence": {
      "type": "object",
      "required": ["rule_applied", "thresholds"],
      "additionalProperties": true,
      "properties": {
        "rule_applied": { "type": "string" },
        "progression_triggers": {
          "type": "array",
          "items": { "type": "integer" }
        },
        "response_triggers": {
          "type": "array",
          "items": { "type": "integer" }
        },
        "thresholds": {
          "type": "object",
          "required": ["progression_pct", "progression_abs_mm", "response_pct"],
          "properties": {
            "progression_pct":    { "type": "number" },
            "progression_abs_mm": { "type": "number" },
            "response_pct":       { "type": "number" }
          }
        }
      }
    },
    "kpi": {
      "type": "object",
      "required": ["data_completeness_score"],
      "additionalProperties": true,
      "properties": {
        "sum_diameters_baseline_mm":   { "type": ["number", "null"] },
        "sum_diameters_current_mm":    { "type": ["number", "null"] },
        "sum_diameters_delta_pct":     { "type": ["number", "null"] },
        "dominant_lesion_baseline_mm": { "type": ["number", "null"] },
        "dominant_lesion_current_mm":  { "type": ["number", "null"] },
        "dominant_lesion_delta_pct":   { "type": ["number", "null"] },
        "lesion_count_baseline":       { "type": "integer" },
        "lesion_count_current":        { "type": "integer" },
        "lesion_count_delta":          { "type": "integer" },
        "growth_rate_mm_per_day":      { "type": ["number", "null"] },
        "volume_mm3_if_available":     { "type": ["number", "null"] },
        "data_completeness_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        }
      }
    },
    "dicom": {
      "type": "object",
      "required": ["metadata", "image_stats"],
      "description": "DICOM analysis block â€” mandatory for all validated pipelines.",
      "properties": {
        "metadata": {
          "type": "object",
          "required": [
            "PatientID",
            "StudyInstanceUID",
            "SeriesInstanceUID",
            "Modality",
            "StudyDate"
          ],
          "additionalProperties": true,
          "properties": {
            "PatientID":          { "type": "string" },
            "StudyInstanceUID":   { "type": "string" },
            "SeriesInstanceUID":  { "type": "string" },
            "Modality":           { "type": "string" },
            "BodyPartExamined":   { "type": ["string", "null"] },
            "StudyDate":          { "type": ["string", "null"] },
            "SeriesDescription":  { "type": ["string", "null"] },
            "InstanceNumber":     { "type": ["integer", "null"] },
            "PixelSpacing": {
              "oneOf": [
                { "type": "null" },
                { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              ]
            },
            "SliceThickness":     { "type": ["number", "null"] }
          }
        },
        "image_stats": {
          "type": "object",
          "required": ["shape", "dtype", "min", "max", "mean", "std", "data_consistency_score"],
          "additionalProperties": true,
          "properties": {
            "shape": {
              "type": "array",
              "items": { "type": "integer" },
              "minItems": 2
            },
            "dtype":  { "type": "string" },
            "min":    { "type": "number" },
            "max":    { "type": "number" },
            "mean":   { "type": "number" },
            "std":    { "type": "number" },
            "data_consistency_score": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            }
          }
        }
      }
    },
    "lesion_deltas": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["lesion_index", "status"],
        "properties": {
          "lesion_index": { "type": "integer" },
          "baseline_mm":  { "type": ["number", "null"] },
          "last_mm":      { "type": ["number", "null"] },
          "delta_mm":     { "type": ["number", "null"] },
          "delta_pct":    { "type": ["number", "null"] },
          "status":       { "type": "string" }
        }
      }
    }
  }
}
